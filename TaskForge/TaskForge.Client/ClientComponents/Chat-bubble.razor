<div class="chat-bubble-clickzone @(isOpen ? "is-open" : "") @(UnreadCount > 0 ? "has-unread" : "")"
     @onclick="ToggleOpen">

    <div class="inner-visual">
        <div class="animated-mail">
            <div class="back-fold"></div>

            <div class="letter">
                <div class="letter-border"></div>
                <div class="letter-title"></div>
                <div class="letter-context"></div>
                <div class="letter-stamp">
                    <div class="letter-stamp-inner"></div>
                </div>
            </div>

            <div class="top-fold"></div>
            <div class="body"></div>
            <div class="left-fold"></div>
        </div>

        @if (UnreadCount > 0)
        {
            <span class="unread-badge">@UnreadCount</span>
        }
    </div>

    @if (isPopupOpen)
    {
        <ChatPopup OnClose="ClosePopup" />
    }
</div>

@code {
    private bool isOpen;
    private bool isPopupOpen;
    private int UnreadCount;
    private bool _initializedClientSide = false;

    protected override void OnInitialized()
    {
        UnreadCount = 0;
    }

    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (!_initializedClientSide)
        {
            var rng = new Random();
            UnreadCount = rng.Next(1, 10); // temporary, later from server
            _initializedClientSide = true;
            Console.WriteLine("HElo");

            StateHasChanged();
        }
    }

    private void ToggleOpen()
    {
        isOpen = !isOpen;

        if (isOpen)
        {
            // opened -> clear unread + show popup
            UnreadCount = 0;
            isPopupOpen = true;
        }
        else
        {
            // closed -> hide popup
            isPopupOpen = false;
        }
    }

    private void ClosePopup()
    {
        isPopupOpen = false;
        isOpen = false;
    }
}
